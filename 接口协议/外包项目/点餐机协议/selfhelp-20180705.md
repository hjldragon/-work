# 点餐收银系统HTTP协议初稿

该文档为初稿，仅定义HTTP输入输出， 不涉及其他内容

#一、登录

## 1.登录协议

### 1.1 点餐机手机登录

####描述


	使用手机登录

#### 输入 GET

	{
		"opr":"login",
		"srctype":4,           //数据来源4,4:自助点餐机
		"phone":"18025302872", //账号或手机号
		"selfhelp_id":"MTBEMDdBNzQ1MjdG", //自助点餐机唯一标识
		"password_md5":"123456", 	 //密码
		"token":"41242154122",  //token值
	}

#### 输出
     
         {
     		"ret":0,
     		"data": {
     		    "shop_id":"4", // 已绑定的店铺id //没有绑定就是null
     		    'phone':"0755-23060180",//检查更新哪里的客服电话
     			"shop_list":[
     				{
     					"shop_id":"4", // 店铺ID
     					"shop_name":"虾米", // 店铺名称
     				}
     				{
                     	"shop_id":"5", // 店铺ID
                     	"shop_name":"虾米", // 店铺名称
                     }
     			]
     		}
         }
#### 输出
	// 该自助点餐机已绑定一个账号的时候,一台点餐机只能绑定一个账户,意味着不能登录其他的点餐机的了，必须接触关联才行
	{
		"ret":-1, 
		"mgs":"自助点餐机已绑定",
		"data":{

		}
	}
### 1.2 微信登录
     ####输入 POST
     
     	{
     		"opr":"login_wx",
     		"user_id":33 // user_id
             "srctype":4,           //数据来源4,4:自助点餐机
             "selfhelp_id":"SH538", //自助点餐机唯一标识
             "token":"41242154122"  //token值
     	}
     
     ####输出
     
     	{
     		"ret":0,
     		"token":"",	
     		"data":{
     			"shop":[
     				{
     			    	"shop_id":"5", // 店铺ID
                        "shop_name":"虾米", // 店铺名称
     				}
     			]
     		}
     	}
#### 输出
	// 该自助点餐机已绑定一个账号的时候,一台点餐机只能绑定一个账户,意味着不能登录其他的点餐机的了，必须接触关联才行
	{
		"ret":-1, 
		"mgs":"自助点餐机已绑定",
		"data":{

		}
	}
### 1.3 登录查询
####输入 POST

	{
		"opr":"login_query",
        "token":"41242154122"  //token值
	}

####输出 
     // 已登录
	{
		"ret":0,
		"token":"",	
		"data":{
			       "userid":"5", // userid
		}
	}
#### 输出 
	// 未登录
	{
		"ret":-10020, 
		"mgs":"用户未登录",
		"data":{

		}
	}
### 1.4 注销登陆
####输入 POST

	{
		"opr":"login_out",
        "token":"41242154122"  //token值
	}

####输出 
     // 已登录
	{
	   "ret": 0,
        "msg": null,
        "data": {}
	}

#二、点餐机系统

##1.1初始化配置

####描述
	
	1.绑定自助点餐机,2.重新只绑定店铺就指传店铺id就行了。

####输入 GET

	{
		"opr":"selfhelp_save",
		"srctype":4,           //数据来源4,4:自助点餐机
		"shop_id":"5",//选择的店铺id
		"selfhelp_id":"SH538",//自助点餐机的唯一标识（必填）
		"selfhelp_name":"自助点餐机名",//自助点餐机名
		"is_using":0,//是否启用(1.启用,0.未启用)
	    "using_type":1,//启用类型(1.联动启用(pc,pad有订单数据显示),2.独立启用(没有订单数据显示))
	    "is_print":0,//是否支持打印(1.支持,0.不支持)
	    "is_wx_send":0,//是否微信模版发送(1.支持,0.不支持)
		}
	}

####输出

	{
		"ret":0, 
		"msg":null,
		"data":{
		}
	}

#### 输出
	// 该自助点餐机已绑定时
	{
		"ret":-1, 
		"mgs":"自助点餐机已绑定",
		"data":{

		}
	}
##1.2点餐机解绑关联   解绑用户 
    
####描述
    	一个用户只能绑定一台点餐机
初始化配置信息
    
####输入 GET
    
    	{
    		"opr":"selfhelp_unbinding",
    		"srctype":4,             //数据来源4,4:自助点餐机
    		"selfhelp_id":"SH538",   //自助点餐机的唯一标识
    		}
    	}
    
####输出
    	{
    		"ret":0, 
    		"msg":null,
    		"data":{
    		}
    	}
##1.2.1点餐机解绑店铺   解绑店铺 
    
####描述
    	
初始化配置信息
    
####输入 GET
    
    	{
    		"opr":"shopid_unbinding",
    		"srctype":4,             //数据来源4,4:自助点餐机
    		"selfhelp_id":"SH538",   //自助点餐机的唯一标识
    		}
    	}
    
####输出
    	{
    		"ret":0, 
    		"msg":null,
    		"data":{
    		}
    	}    	
 ##1.3获取自助点餐机信息  
 ####描述
 	
 	检查更新
 
 ####输入 POST
     {
         "opr":"get_selfhelp_info", //接口名称
         srctype:4,                 // 数据来源（1:收银机端,2.装柜通,4.自助点餐机）
         "selfhelp_id":"SH538",   //自助点餐机的唯一标识
     }
 ####输出
     {
     "ret": 0,
     "data": {
          "selfhelp_id": "SH538",
          "selfhelp_name": "自助点餐机名",
          "userid": 33,        // 绑定用户id(一个账号只能绑定一个账号) //如果有id和shop_id就是绑定。null就是未绑定
          "shop_id": "5",       
          "is_using": 0,     // 是否启用这台自助点餐机(1.启用,0.未启用)
          "using_type": 2,           //启用类型(1.联动启用(pc,pad有订单数据显示),2.独立启用(PAD没有订单数据显示))
          "is_print": 1,                  // 是否支持打印(1.支持,0.不支持) 
          "is_wx_send": 0,                // 是否微信模版发送(1.支持,0.不支持)
          "remark": "我的作用是给下个人看",  //备注
          "lastmodtime": 1525764085,
          "delete": 0
         }    
     }
#六、关于我们中检查更新

##6.1检查更新  
####描述
	
	检查更新

####输入 POST
    {
        "opr":"version_get", //接口名称
        srctype:4,                   // 数据来源（1:收银机端,2.自助点餐机,3.扫码点餐,4.平板智能点餐机）
        version_code:"1.1.0",       //  版本号
        platform:2,                 //  版本系统,1.ios,2.android
    }
####输出
    {
    "ret": 0,
    "data": {
           "version_id": "VN195",
           "version_day": 1524900960, //版本发布日期
           "force_update": false,标识推送下来的版本是否强制升级
           "version_code": "3.0.8",//版本号
           "version_name": "收银机0428002版",
           "version_desc": "版本描述",
           "version_url": "http://dl.jzzwlcm.com/apk/app-debug-3.0.8.apk",
           "srctype": 4,
           "lastmodtime": 1524900960,
           "delete": 0,
           "platform": 2,
           "need_update": true,标识推送下来的版本是否需要升级
        }    
    }
##2. 获取菜单列表
	
####描述

	获取菜单列表协议，会在登录成功后调用。

####输入 GET

	{
		"opr":"selfhelp_food_list", // 参数
		 srctype:4,                 // 数据来源（1:收银机端,2.装柜通,4.自助点餐机）
		"shop_id":"5",              // 店铺id
		"sale_way_list":[4],        // 打包 ,不打包就不传。
	}

####输出

	{
    "ret": 0,
    "data": {
    "food_list": [
       {
               "food_id": "FO1702",  //food_id
               "shop_id": "5",  
               "food_name": "说过啦",  //食物名称
               "category_id": "CA1481",
               "stock_num_day": 0,
               "food_price": {
                    "type": 1, //不使用规格
                    "using": 1,
                    "price": [
                                 {
                                     "spec_type": 0,
                                     "original_price": 200,//普通价格
                                     "discount_price": 100,//促销价格
                                     "vip_price": 0,
                                     "festival_price": 0,
                                     "is_use": 0
                                 }
                             ]
                         },
                         "food_intro": null,
                         "praise_num": 10,//点赞数
                         "food_img_list": [],
                         "entry_time": 1525327750,
                         "lastmodtime": 1525327750,
                         "delete": null,
                         "food_attach_list": [     {    // 口味
                                             "title": "辣度",  //口味名称
                                             "spc_value": [
                                              "微辣",    
                                              "不辣",
                                              "特辣",
                                              "少盐"
                                              ]
                                             },
                                             {
                                             "title": "盐味",
                                             "spc_value": [
                                             "少盐",
                                             "多盐",
                                             "无盐"
                                             ]
                                            }],
                         "food_unit": "盘",
                         "need_waiter_confirm": null,
                         "sale_off": 0,
                         "accessory": "",
                         "accessory_num": 0, //餐盒个数
                         "pack_remark": "",
                         "composition": null,
                         "feature": null,
                         "sale_way": [
                             1,
                             2
                         ],
                         "sale_num": 1,
                         "sale_off_way": 0,
                         "food_sale_time": [],
                         "food_sale_week": null,
                         "type": 1,
                         "is_draft": 0,
                         "food_num_mon": 0,           //月售数量
                         "category_name": "春菜系列", //分类名称
                         "day_sell_num": 0
                         "inventory":9999,    //剩余库存
                         "food_img": "http://shop.jzzwlcm.com/php/img_get.php
                        ?img=1&imgname=baefd59dfdc66e917af8048654ed0cce.jpg",  //餐品图片
                     },
                     "accessory_price": 0.01  //餐盒费
                    {
                                   "food_id": "FO1274",
                                   "shop_id": "5",
                                   "food_name": "招牌黄焖鸡",
                                   "category_id": "CA1481",
                                   "stock_num_day": 12,
                                   "food_price": {
                                       "type": 2,//使用规格
                                       "using": 3,//使用哪个价格的位标志(1:原价,2:折扣价,4:会员价,8:节日价)(位运算)
                                       "price": [
                                           {
                                               "spec_type": 1,//大
                                               "original_price": 30,
                                               "discount_price": 28,
                                               "vip_price": 0,
                                               "festival_price": 0,
                                               "is_use": 1
                                           },
                                           {
                                               "spec_type": 2,//中
                                               "original_price": 25,
                                               "discount_price": 20,
                                               "vip_price": 0,
                                               "festival_price": 0,
                                               "is_use": 1
                                           },
                                           {
                                               "spec_type": 3, //小
                                               "original_price": 20,
                                               "discount_price": 18,
                                               "vip_price": 0,
                                               "festival_price": 0,
                                               "is_use": 1
                                           }
                                       ]
                                   },
                                   "food_intro": null,
                                   "praise_num": 0,
                                   "food_img_list": [
                                       "299d74793bf8624791df440f4bda1765.jpg"
                                   ],
                                   "entry_time": 1524119110,
                                   "lastmodtime": 1525749179,
                                   "delete": null,
                                   "food_attach_list": [],
                                   "food_unit": "盘",
                                   "need_waiter_confirm": null,
                                   "sale_off": 0,
                                   "accessory": "",
                                   "accessory_num": 0,
                                   "pack_remark": "",
                                   "composition": [  // 食材
                                       "茶树菇",
                                       "酸菜",
                                       "猪肚",
                                       "虾",
                                       "猪肉",
                                       "鸡肉",
                                       "青椒",
                                       "1",
                                       "2",
                                       "3"
                                   ],
                                   "feature": [  // 特色
                                       "食神世家",
                                       "古方秘制",
                                       "私房菜",
                                       "盐味",
                                       "55",
                                       "椒盐味",
                                       "番茄味",
                                       "重辣",
                                       "1",
                                       "2"
                                   ],
                                   "sale_way": [
                                       1,
                                       2
                                   ],
                                   "sale_num": 1,
                                   "sale_off_way": 0,
                                   "food_sale_time": [
                                       {
                                           "start_time": 1524187740,
                                           "end_time": 1524190440
                                       }
                                   ],
                                   "food_sale_week": null,
                                   "type": 1,
                                   "is_draft": 0,
                                   "food_num_mon": 0,
                                   "category_name": "春菜系列",
                                   "day_sell_num": 0,
                                   "inventory": 12，
                                   "accessory_price": 0  //餐盒费
                               },
                               }
	}


##4.立即付款（下单）

####描述

	点击下单按钮，提交后台, 提交data数据为JSON字符串

####输入 POST

	{
		"opr":"order_save",
		srctype:4,                 // 数据来源（1:收银机端,2.装柜通,4.自助点餐机）
		"selfhelp_id":"SH538",   //自助点餐机的唯一标识
		"shop_id":"5",
		"dine_way":1,              // 用餐方式(1:在店吃,3:打包)
		"customer_num":4,   //顾客数量
		"customer_phone":"182131544548",   //顾客电话号码
		"order_remark":"123", // 整单备注   
        "totalprice":0.03,    //总价
        "food_list":[
           {
            "food_id":"FO1274", // 菜品ID
            "food_name":"招牌黄焖鸡",
            "food_num":1, // 数量
            "food_price":0.03, // 价格
            "weight":1, // 份量规格(1:大份,2:中份,3:小份)
            "attribute": [
                {
                 "title": "超级好味道",
                 "spc_value": "多盐"
                 }
                 ],
            	}
            ]	
	}

####输出

	// 库存不足时
	{
	    "ret": -30025,
        "msg": "餐品存量不够",
        "data": {
            "food_id": "FO2294",
            "food_name": "0元菜品免费试吃",
            "surplus_num": 1
        }
	}
	// 已下架
	{
	    "ret": -30038,
         "msg": "餐品已下架",
         "data": {
            "food_id": "FO2294",
            food_name": "0元菜品免费试吃"
         }
	}
    //正常返回
	{
		"ret":0, 
		"mgs":"",
		"data":{
			 "order_id":100099889000, // 订单编号
	         'all_price':10000.01 //订单总价
		}
	}
##5.1订单支付
#############5.1.1生成订单支付二维码
####描述
	获取订单二维码信息(二维码由前端生成)
####输入 GET

	{
		"opr":"qrpay",
		"qr_name":"wx_qrpay",     //wx_qrpay微信二维码，alipay_qrpay支付宝二维码
		srctype:4,                 // 数据来源（1:收银机端,2.掌柜通,4.自助点餐机）
        "order_id":"266"  //订单号
        "price":"58"      //支付金额,在你付款的时候返回给你了
        "token":"12648774877877"      //token值    
	}

####输出
    //不需要输入密码
	{
		"ret":0,
		"data":{
                "url": "4200000015201712228935918301",//二维码内容 
		}
	}

#############5.1.2扫用户二维码
####描述
	
	主动扫描用户二维码， 得到二维码信息上传服务器

####输入 POST
              <<<<<<<<<<<<<<<<<<<<<<支付宝返回结果数据还在开发中
	{
		"opr":"micropay",
        "order_id":"266"  //订单号
        "qr_name":"wx",     //wx微信二维码，alipay支付宝二维码
        srctype:4,                // 数据来源（1:收银机端,2.掌柜通,4.自助点餐机）
       "price":"58"              //支付金额,在你付款的时候返回给你了
        "auth_code":"12648774877877"      //用户支付码    
	}

####输出
    //不需要输入密码
	{
		"ret":0,
		"token":"",
		"data":{
			            "order_id": "266",
                        "transaction_id": "4200000015201712228935918301",
                        "out_trade_no": "1513927423_266",
                        "is_pay": "1",//有这个字段，且为1表示支付成功.
                        "pay_price": "0.01",
                        "lastmodtime": "1513927890"  
		}
	}
	//需要输输入密码情况返回,根据 vb 来查询
	{
    		"ret":-300042,
    		"data":{
    		
    		}
    	}
##########5.1.3点餐机扫用户二维码的支付接口
####描述
	
	主动扫描用户二维码支付完成后调用该接口 <<<<<<<<<<<<<<<<<<<<<<<<<<目前支付宝要输入密码的还在开发中

####输入 POST

	{
		"opr":"payquery",
		"qr_name":"wx",     //wx微信二维码，alipay支付宝二维码
		srctype:4,                // 数据来源（1:收银机端,2.掌柜通,4.自助点餐机）
        "order_id":"266"          //订单号 
	}

####输出

	{
		"ret":0,
		"token":"",
		"data":{
			            "order_id": "266",
                        "transaction_id": "4200000015201712228935918301",
                        "out_trade_no": "1513927423_266",
                        "is_pay": "1",
                        "pay_price": "0.01",
                        "lastmodtime": "1513927890"  
		}
	}

##6.1获取打印信息
####描述
	
	获取打印信息

####输入 POST
    {
        "opr":"get_print_info", //接口名称
        "order_id":"SL11546",	    
    }
####输出
    {
           "ret": 0,
           "msg": null,
           "data": {
               "orderInfo": {
                   "orderNum": "SL11546",
                   "tableNum": null,
                   "customerNum": 4,
                   "seqNo": "2018051011491",
                   "operUser": "--",
                   "waiter": "--",
                   "startTime": "2018-05-10 18:34:57",
                   "printTime": "2018-05-11 11:39:16"
               },
               "productInfo": {
                   "totalCount": 1,
                   "totalPrice": 0.01,
                   "sq_code_url": "扫码自助开发票功能即将上线，敬请期待…",
                   "mark": "123",
                   "productList": [
                       {
                           "id": "FO1274",
                           "name": "招牌黄焖鸡",
                           "unit_price": 0.01,
                           "count": 1,
                           "price": 0.01,
                           "level_one_id": "156",
                           "level_two_id": "CA1480"
                       },
                       {
                           "id": null,
                           "name": "餐位费",
                           "unit_price": "",
                           "count": "",
                           "price": null,
                           "level_one_id": "",
                           "level_two_id": ""
                       }
                   ]
               },
               "pay_info": {
                   "need_money": 0.01,
                   "need_money_extend": [],
                   "real_money": 0.01,
                   "real_money_extend": [
                       {
                           "name": "微信支付",
                           "price": 0.01
                       }
                   ],
                   "sq_code_url": "扫码自助开发票功能即将上线，敬请期待…",
                   "mark": "123"
               },
               "back_pay_info": null,
               "pre_pay_info": null
           }
    }
#七、个人
#############6.2
####描述
      #####获取公钥
####输入 GET

	{
		"opr":"get_rsa_pubkey",
		srctype:4,                 // 数据来源（1:收银机端,2.装柜通,4.自助点餐机）
	}

####输出
    //不需要输入密码
	{
	    "ret": 0,
        "data": {
            "publickey": "-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQClnAfSpNh3EMKoMGN10MWlCmV+\n8lcYU92GnvgHVlFn9rS9aZEig9Dy+9Wos13Zfszp3qfPo7NlnXP59CUKlC07zw/Z\n8VPJsHQrsah2HX6nQXKlgyFcqB6q6GoRI4Vp36Vdu8XoNSiWsz7KpBY7MHgMy4uA\nxsH7vYPq9U30Q0sBlwIDAQAB\n-----END PUBLIC KEY-----",
            "expire": 1715579637
        },
        "msg": null
	}